<html>
<head>
<title>
Block Locking
</title>

<style type="text/css">

<!--
/*  TwinText Style (c) PTLogica 2002 - 2004  */

 
/* Body */
body{font-family:"Verdana", sans-serif;font-size: 8pt; }

/* Body (Chapter) */
body.Main{background: #FFFFFF;color: #000000;  margin: 0;       }

/*IE 5.5 */
li, table {  font-family: "Verdana", sans-serif; font-size: 8pt;  }

/* Project Title */
div.ProjectTitle {
	font-style: italic;
	font-size: 8pt;
	font-weight: normal;
	color: White;
	text-align: left;
	padding-bottom: 3px;
}

/* Chapter's Title */
h1{font-family:"Verdana", sans-serif;font-size: 14px;
font-weight: bold;text-align: left;margin-left: 0pt;margin-right: 0pt;margin-top: 0px;margin-bottom: 9px;    padding-top: 15px;  padding-bottom: 15px;  padding-left: 10px;  background-color: #006699;  color: White;
 border-bottom: 4px solid Black;}
 
/* Feedback */
div.Feedback {
 	font-style: italic;
	font-size: 8pt;
	font-weight: normal;
    text-align: right;
    margin: 0px;
    padding: 2px;
    background: #EFEFEF;
    position: relative; top: -10px; left: 0px;
} 

/* Common to all section text, including first section */
div.SectionText{margin-left: 10px;margin-right: 10px;margin-top: 10px;margin-bottom: 10px;   }

/* Contents or Summary */
h2{font-family:"Verdana", sans-serif;font-size: 11pt;font-weight: bold;text-align: left;margin-left: 5px;margin-right: 0pt;margin-top: 5pt;margin-bottom: 2pt;}

/* Table of Contents */
div.Toc{margin-top: 30px;margin-bottom: 30px;  border: 1px solid #CCCCCC;  padding: 5px;  margin-left: 30px;  margin-right: 30px;    }
div.TocLinks{font-weight: normal;text-align: left;margin-left: 0pt;margin-right: 0pt;margin-top: 0pt;margin-bottom: 0pt;}
ul.TocLinks{}
li.TocLink{}
a.TocLink{}

/* Summary */
div.Summary{margin-top: 20px;margin-bottom: 40px;    padding: 5px;  margin-left: 30px;  margin-right: 20px; }
table.SummaryTable{  margin-top: 15px;  margin-bottom: 15px;  background-color: transparent;                   }
tr.SummaryRow { }
td.SummaryLink{font-weight: normal;text-align: left;width: 15%;        padding: 5px;             }
td.SummaryText{text-align: left;      padding: 5px;  background-color: transparent;  color: Black;                    }
a.SummaryLink{ }

/* Sections */
div.AllSections{margin-top: 0;margin-bottom: 70px;  margin-left: 0;  margin-right: 0;  }

div.Section{margin-top: 30px;margin-bottom: 10px;}
h3{font-family:"Verdana", sans-serif;font-size: 11pt;font-weight: bold;text-align: left;margin-left: 0pt;margin-right: 0pt;margin-top: 5pt;margin-bottom: 10px;  padding-left: 10px;  padding-bottom: 3px;  background: #6699CC;  color: White;  border-bottom: 1px solid Black;     }

/* API Box */
div.Api{font-family:"Courier New", monospace;font-size: 9pt;margin-left: 15px;margin-right: 15px;margin-top: 15px;margin-bottom: 15px;padding: 7px;color: Black;  border: 1px solid #CCCCCC;  background: transparent;  }
font.ApiName{font-weight: bold;  background-color: transparent;  color: Black;  }

/* Section Text Elements */
h4{font-family:"Verdana", sans-serif;font-size: 9pt;font-weight: bold;margin-left: 0pt;margin-right: 0pt;margin-top: 5pt;margin-bottom: 2pt;}
pre{font-family:"Courier New", monospace;font-size: 11px;white-space: pre;margin-top: 7pt;margin-bottom: 7pt;  border: 1px dashed #CCCCCC;  padding: 5px;  margin-left: 5px;  margin-right: 5px;  color: Black;     }
font.HighText{ background-color: #FFFF00; color: Black;  font-weight: normal;}
ul{}
li{list-style: disc;}
a:link{text-decoration:none;color: #005499;background: transparent;}
a:visited{text-decoration:none;color: #005499;background: transparent;}
a:active{text-decoration:none;color: #005499;background: transparent;}
a:hover{text-decoration:underline;color: #005499;background: transparent;}
	
	/* Definitions Table */
table.DefTable{ margin-left: 20px;  margin-right: 20px;   }
tr.Def{  }
td.Def{font-family:"Courier New", monospace;font-size: 9pt;  font-weight: normal;   padding-left: 5px;  padding-right: 5px;      color: Black;  vertical-align: top;  white-space: nowrap;  text-align: left;            }
td.DefSep{font-family:"Courier New", monospace;font-size: 9pt;padding-right: 5pt;padding-left: 5pt;  vertical-align: top;  text-align: center;  }
td.DefText{ vertical-align: top;  text-align: left;  }

/* Copyright */
div.Copy { padding: 10px;  }

/* Footer */
div.Footer{ border-top: 1px solid #CCCCCC;  margin-top: 10px;  padding: 5px;  border-bottom: 1px solid #CCCCCC;    }

div.SourceLocation{background: transparent;color: rgb(130,130,130);  font-size: 8pt;  margin-bottom: 10px;  margin-left: 10px;   }
div.LastGenerated{background: transparent;color: rgb(130,130,130);  font-size: 8pt;  margin-left: 40px;  }


/* Navigation */
body.Side{background: #6699CC;color: White;  margin: 0px;  padding: 0px;  }
div.Side{}
/* not well supported in some versions of IE; remove background color and bottom border */
/*div.SideTitle{font-family:"Verdana", sans-serif;font-size: 14px;color: White;font-weight: bold;text-align: left;margin-left: 0pt;margin-right: 0pt;margin-top: 0px;margin-bottom: 0px;  background-color: #006699;  padding-top: 15px;  padding-bottom: 15px;  padding-left: 5px;  border-bottom: 4px solid Black;} */
div.SideTitle{font-family:"Verdana", sans-serif;font-size: 14px;color: #000000;font-weight: bold;text-align: left;margin-left: 0pt;margin-right: 0pt;margin-top: 0px;margin-bottom: 0px;  padding-top: 15px;  padding-bottom: 15px;  padding-left: 7px; }
div.SideText{text-align: left;margin-top: 0px;margin-bottom: 5px;  margin-left: 0px;  margin-right: 0px;  padding-bottom: 9px;    padding-left: 7px;  color: #FFCC00;  background: #6699CC;  padding-top: 10px;  font-weight: bold;               }
div.SideDetail { font-family: Arial, serif;  font-size: 10pt;  font-weight: normal;  background: transparent;    margin: 0px;  background-color: transparent;  padding-top: 1px;  color: White;                              }
ul.SideDetail{     }
li.SideDetail{ white-space: nowrap;  list-style: square;        }
a.SideDetail:link { text-decoration: none; color: #ffffff; font-family: Verdana, Arial, sans-serif; font-size: 12px; font-weight: bold; }
a.SideDetail:visited { text-decoration: none; color: #ffffff; font-family: Verdana, Arial, sans-serif; font-size: 12px; font-weight: bold; }
a.SideDetail:hover { text-decoration: underline; color: #ffffff; font-family: Verdana, Arial, sans-serif; font-size: 12px; font-weight: bold; }
table.LinksTable{margin-top: 10px;margin-bottom: 10px; padding-left: 7px;      }
tr.SideLink{}
td.SideLink{}
a.SideLink:link { text-decoration: none; color: #ffffff; font-family: Verdana, Arial, sans-serif; font-size: 11px; }
a.SideLink:visited { text-decoration: none; color: #ffffff; font-family: Verdana, Arial, sans-serif; font-size: 11px; }
a.SideLink:hover { text-decoration: underline; color: #ffffff; font-family: Verdana, Arial, sans-serif; font-size: 11px; }







-->

</style>

<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="GENERATOR" content="TwinText">

</head>
<body class=Main>
<h1>
Block Locking
</h1>
<div class=Feedback><a href="mailto:support@datalight.com?subject=Documentation Feedback: FlashFX Tera SDK for Microsoft Windows CE -- v2.1.1 Build 2128DF (Win32 Host): Block Locking">Send comments on this topic.</a></div>
<div class=SectionText>

        <h4>Overview</h4>
        
<p>        Many modern flash technologies include support for block locking, 
        whereby the flash cannot be programmed or erased while the erase block 
        is locked.

<p>        There are a wide variety of locking schemes.  Some schemes allow 
        individual blocks to be discretely locked and unlocked, independently
        of any other blocks, while other schemes only allow ranges of blocks
        to be locked or unlocked, automatically applying the opposite state 
        to the blocks outside the range.

<p>        Newer NAND flash has the ability to freeze the block lock state, such
        that it cannot be changed (in either direction) until such time as the
        system is reset and powered up.  Various manufacturers use different
        terms to describe this ability -- FlashFX refers to it as "Lock-Freeze".

<p>        FlashFX default behavior in most NOR FIMs and NAND NTMs which support 
        locking is to simply unlock all the flash when FlashFX starts up.  
        Recent versions of FlashFX have new NTM interfaces which give the OEM 
        control over block locking.

<p>        <h4>Discrete Block Locking</h4>

<p>        For flash technologies which support discrete block locking, things are
        pretty simple from a usability perspective.  FlashFX lock and unlock
        commands are available in the FML API, and such commands affect only
        the blocks in that FML Disk.

<p>        <h4>Range Block Locking</h4>
        
<p>        For flash technologies which only support lock ranges, things are much
        more complex, and the OEM <b>must</b> take appropriate actions based on this
        scheme.  

<p>        Most range locking schemes specify that lock commands may only be issued
        for the entire flash chip, locking all the blocks.  To unlock blocks, 
        only a single range of flash may be specified, though they support an 
        "invert" option, so that you can, in effect, specify two ranges of 
        flash be unlocked, with the remainder locked.  Whenever the command is 
        issued, all the blocks outside the specified range are set to the 
        opposite state.  

<p>        The effects of this on the FlashFX API are severe, for the 
        following reasons:
        <ul>
<li>This affects every erase block in the chip, not just the erase blocks in the current FlashFX Disk.
        <li>This also affects reserved flash areas which FlashFX is not managing.
        <li>This affects the blocks used by BBM, which are often not contiguous with the blocks in a given FlashFX Disk.
</ul>
        For example, suppose you have a flash chip containing 1024 erase blocks,
        which is laid out in the following fashion:
        
<p><table class=DefTable>
<tr class=Def>
<td class=Def>
10
</td>
<td class=DefSep>-</td>
<td class=DefText>
Reserved blocks, bootloader code, which for the sake of this example, are not read or written using FlashFX.
</td>
</tr>

<p>        
<tr class=Def>
<td class=Def>
1
</td>
<td class=DefSep>-</td>
<td class=DefText>
Configuration data, the first block managed by FlashFX.
</td>
</tr>

<p>        
<tr class=Def>
<td class=Def>
100
</td>
<td class=DefSep>-</td>
<td class=DefText>
DISK0 blocks, containing a read-only OS image.
</td>
</tr>

<p>        
<tr class=Def>
<td class=Def>
200
</td>
<td class=DefSep>-</td>
<td class=DefText>
DISK1 blocks, file system VOLUME0.
</td>
</tr>

<p>        
<tr class=Def>
<td class=Def>
669
</td>
<td class=DefSep>-</td>
<td class=DefText>
DISK2 blocks, file system VOLUME1.
</td>
</tr>

<p>        
<tr class=Def>
<td class=Def>
24
</td>
<td class=DefSep>-</td>
<td class=DefText>
BBM spare blocks
</td>
</tr>

<p>        
<tr class=Def>
<td class=Def>
20
</td>
<td class=DefSep>-</td>
<td class=DefText>
Reserved blocks, ignored by FlashFX.
</td>
</tr>
</table>

<p>
        In an ideal configuration, the following lock states would be
        in effect:
        <ul>
<li>The 10 reserved blocks would be in an unknown state from a FlashFX perspective, because they are reserved, and by definition, FlashFX does not touch them, even to read their state.
        <li>The 1 configuration data block would be locked normally, but unlocked when being updated (assuming that a Lock-Freeze feature is not in effect).
        <li>The 100 DISK0 blocks would be locked, because they contain the OS image, which is read-only and not modified in normal use.
        <li>The 200 DISK1 blocks would be unlocked.
        <li>The 669 DISK2 blocks would be unlocked.
        <li>The 24 BBM spare blocks would be in the same lock state as the blocks from which they are remapped.
        <li>The 20 reserved blocks would be in an unknown state from a FlashFX perspective, because they are reserved, and by definition, FlashFX does not touch them, even to read their state.
</ul>
        This is impossible to do with current flash manufacturer's range block
        locking schemes.  The best that can be done is to organize the use of
        the flash in a fashion which better suits the block locking requirements.
        Therefore, FlashFX will recognize the flash hardware restrictions, and
        modify unlock requests appropriately.  

<p>        For example, attempting to unlock configuration data block 10 would 
        normally result in all the other blocks becoming locked.  Even if this 
        were acceptable to the OEM, it would be completely inappropriate to 
        lock the BBM area since it may have remapped block 10 into that area, 
        and the attempt to write the configuration data would fail if the block 
        was locked. Therefore, when the unlock request for block 10 is 
        processed, FlashFX will automatically extend the range to the end of BBM,
        resulting in the reserved blocks at the beginning and end of the flash
        remaining locked, and everything else being unlocked.

<p>        Additionally, it should be clear that this block locking scheme is 
        problematic from the perspective of the FlashFX API, which is 
        constructed around the paradigm that FML operations are made to FlashFX 
        Disks, and any such request to modify DISK1 (for example), should have 
        <b>no</b> affect on any other Disks.  This plainly is not the case when 
        locking operations have chip-wide effects.

<p>        In summary, when using a range-locking scheme which affects the entire
        flash array, follow these guidelines:
        
<p><table class=DefTable>
<tr class=Def>
<td class=Def>
1
</td>
<td class=DefSep>-</td>
<td class=DefText>
To the best degree possible, organize the data such that locked and unlocked areas are contiguous, preferably with locked areas only at the very beginning and/or very end of the flash array.
</td>
</tr>

<p>        
<tr class=Def>
<td class=Def>
2
</td>
<td class=DefSep>-</td>
<td class=DefText>
As an OEM using the FlashFX APIs, understand the side effects of issuing a range based locking/unlock command.
</td>
</tr>

<p>        
<tr class=Def>
<td class=Def>
3
</td>
<td class=DefSep>-</td>
<td class=DefText>
Be aware that third-party tests which exercise locking functionality, may not be prepared for BBM remapped blocks which are seen as unlocked, even though the original block may be locked.
</td>
</tr>

<p>        
<tr class=Def>
<td class=Def>
4
</td>
<td class=DefSep>-</td>
<td class=DefText>
Use the soft-lock feature described below.
</td>
</tr>
</table>

<p>        

<p>
                                                                                                    
</div>
<div class=AllSections>
</div>
<div class=Copy>Datalight FlashFX Tera SDK for Microsoft Windows CE<br>Copyright &#169; 1993-2012 Datalight, Inc.  All Rights Reserved Worldwide.</div>
</body>
</html>

